name: Image Publish

on:
  release:
    types: [ published ]
    tags:
      - v*      
  workflow_dispatch:
    inputs:
      tags:
        description: 'Publish images'  

env:
  CLIENT_IMAGE_NAME: weather-frontend
  SERVER_IMAGE_NAME: weather-backend

jobs:
  publish-client:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: weather-frontend

    steps:
    - uses: actions/checkout@v4
    - name: Build the Docker image
      run: docker build . --tag $CLIENT_IMAGE_NAME

    - name: Log into registry
      run: echo "${{ secrets.CR_PAT }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

    - name: Push frontend image
      run: |
        echo IMAGE_NAME=frontend
        IMAGE_ID=ghcr.io/${{ github.repository }}/$CLIENT_IMAGE_NAME

        # Change all uppercase to lowercase
        IMAGE_ID=$(echo $IMAGE_ID | tr '[A-Z]' '[a-z]')

        echo IMAGE_ID=$IMAGE_ID

        docker tag $CLIENT_IMAGE_NAME $IMAGE_ID:latest
        docker push $IMAGE_ID:latest
        
  publish-server:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: weather-backend/WeatherBackend/WeatherBackend

    steps:
    - uses: actions/checkout@v4
    - name: Build the Docker image
      run: docker build . --tag $SERVER_IMAGE_NAME

    - name: Log into registry
      run: echo "${{ secrets.CR_PAT }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

    - name: Push frontend image
      run: |
        echo IMAGE_NAME=frontend
        IMAGE_ID=ghcr.io/${{ github.repository }}/$SERVER_IMAGE_NAME

        # Change all uppercase to lowercase
        IMAGE_ID=$(echo $IMAGE_ID | tr '[A-Z]' '[a-z]')

        echo IMAGE_ID=$IMAGE_ID

        docker tag $SERVER_IMAGE_NAME $IMAGE_ID:latest
        docker push $IMAGE_ID:latest
