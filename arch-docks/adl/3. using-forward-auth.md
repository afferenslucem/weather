# Использование Forward Auth

Status: Approved

## Change Log

- [created]  2025-11-19

## Context

В текущем состоянии системы было решено использовать API Gateway. 
Этот подход так же может помочь упростить процесс проверки JWT: выбранный ранее Traefik может работать с ForwardAuth, для проверки корректности присланного токена.

## Proposed Design

Предлагается использовать для этой цели Auth сервис, который итак планируется в разработке, но добавить ему возможность валидировать токены.

При получении запроса API Gateway будет пресылать JWT на условный `/validate` ендпоинт, а Auth сервис будет возвращать ответ `200`/`401`.

## Considerations

### Alternatives

Из альтернатив:
- **Не использовать ForwardAuth, а использовать проверку токена в каждом сервисе независимо. ** 
Не рассматривается, так как в таком слачает будет необходимо дублировать процесс проверки.
- **Не использовать ForwardAuth, а использовать проверку самого API Gateawy.**
Подобный функционал поддерживается только платной версией Traefik. Это означает, что надо или ее купить (нет, так как это учебный pet-проект), либо выбирать другую технологию, а технология уже выбрана.

### Risks

- **ForwardAuth это единая точка отказа, если не создавать резервные инстансы**.
- **JWT может протечь в логи**

### Consequences

#### Positive

- **Упрощается код остальных сервисов, так как его просто напросто становится меньше**
- **Проверка валидности токена становится централизованной**
- **Мной будет изучен подход, который используется в крупных компаниях**

#### Negative

- **Добавляется один промежуточный запрос, во время действий подльзователя**  
Так как он выполняется внутри кластера, то это не должно сильно повлиять на latency, кроме того JWT криптография легковесна
- **Сервис аутентификации может стать узким горлышком**  
В нашем случае риск не велик, так как сервис будет реализован stateless, так что его можно будет горизонтально масштабировать
- **Возрастает нагрузка на сеть**

## Decision

Решено использовать ForwardAuth и добавить ендпоинт` /validate` в Auth сервис.

## Related ADRs

- [ADR на использование API Gateway](./2.%20add-api-gateway.md)
